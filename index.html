<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Notes Viewer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Source+Serif+4:ital,opsz,wght@0,8..60,400;0,8..60,600;1,8..60,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-hover: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-orange: #d29922;
            --accent-red: #f85149;
            --accent-purple: #a371f7;
            --accent-cyan: #39c5cf;
            --border-color: #30363d;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --font-mono: 'JetBrains Mono', monospace;
            --font-serif: 'Source Serif 4', Georgia, serif;
            --highlight-bg: #ffe066;
            --highlight-active: #ff6b6b;
        }
        body.light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f6f8fa;
            --bg-tertiary: #eaeef2;
            --bg-hover: #e1e4e8;
            --text-primary: #24292e;
            --text-secondary: #586069;
            --text-muted: #6a737d;
            --accent-blue: #0366d6;
            --accent-green: #28a745;
            --accent-orange: #b08800;
            --accent-red: #cb2431;
            --accent-purple: #6f42c1;
            --accent-cyan: #0184bc;
            --border-color: #e1e4e8;
            --highlight-bg: #fff5b1;
            --highlight-active: #ff6b6b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-serif); background: var(--bg-primary); color: var(--text-primary); line-height: 1.7; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 340px; min-width: 340px; background: var(--bg-secondary); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; }
        .sidebar-header { padding: 24px; border-bottom: 1px solid var(--border-color); }
        .sidebar-logo { font-family: var(--font-mono); font-size: 14px; font-weight: 600; color: var(--accent-blue); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
        .sidebar-title { font-size: 22px; font-weight: 600; color: var(--text-primary); }
        .nav-container { flex: 1; overflow-y: auto; padding: 16px; }
        .master-toc-container { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); margin-bottom: 16px; overflow: hidden; }
        .master-toc-header { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; transition: background 0.2s ease; user-select: none; border-bottom: 1px solid var(--border-color); }
        .master-toc-header:hover { background: var(--bg-hover); }
        .master-toc-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 14px; transition: transform 0.2s ease; }
        .master-toc-container.open > .master-toc-header .master-toc-icon { transform: rotate(90deg); }
        .master-toc-title { font-family: var(--font-mono); font-size: 13px; font-weight: 600; color: var(--accent-purple); flex: 1; }
        .master-toc-content { display: none; padding: 8px 12px; max-height: 400px; overflow-y: auto; }
        .master-toc-container.open > .master-toc-content { display: block; }
        .master-toc-note { margin-bottom: 12px; }
        .master-toc-note-title { font-family: var(--font-mono); font-size: 12px; font-weight: 600; color: var(--accent-blue); margin-bottom: 4px; display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 4px 8px; border-radius: var(--radius-sm); transition: background 0.2s ease; }
        .master-toc-note-title:hover { background: var(--bg-hover); }
        .master-toc-heading { font-size: 12px; color: var(--text-secondary); padding: 3px 8px 3px 24px; cursor: pointer; border-radius: var(--radius-sm); transition: all 0.2s ease; display: block; text-decoration: none; }
        .master-toc-heading:hover { background: var(--bg-hover); color: var(--text-primary); }
        .master-toc-heading.level-2 { padding-left: 36px; font-size: 11px; }
        .special-nav-item { display: flex; align-items: center; padding: 10px 16px; margin-bottom: 12px; border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s ease; font-family: var(--font-mono); font-size: 13px; }
        .special-nav-item:hover { transform: translateX(4px); }
        .special-nav-item.active { color: var(--bg-primary) !important; }
        .readme-item { background: linear-gradient(135deg, rgba(88, 166, 255, 0.1), rgba(163, 113, 247, 0.1)); border: 1px solid var(--accent-blue); color: var(--accent-blue); }
        .readme-item:hover { background: linear-gradient(135deg, rgba(88, 166, 255, 0.2), rgba(163, 113, 247, 0.2)); }
        .readme-item.active { background: var(--accent-blue); }
        .public-all-item { background: linear-gradient(135deg, rgba(63, 185, 80, 0.1), rgba(57, 197, 207, 0.1)); border: 1px solid var(--accent-green); color: var(--accent-green); }
        .public-all-item:hover { background: linear-gradient(135deg, rgba(63, 185, 80, 0.2), rgba(57, 197, 207, 0.2)); }
        .public-all-item.active { background: var(--accent-green); }
        .special-nav-item-emoji { margin-right: 10px; font-size: 16px; }
        .main-content { flex: 1; margin-left: 340px; display: flex; flex-direction: column; }
        .top-bar { position: sticky; top: 0; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); padding: 16px 32px; z-index: 50; display: flex; align-items: center; gap: 16px; justify-content: space-between; }
        .top-bar-left { display: flex; align-items: center; gap: 16px; flex: 1; }
        .top-bar-right { display: flex; align-items: center; gap: 12px; }
        .theme-toggle { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 8px 12px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; font-size: 16px; display: flex; align-items: center; justify-content: center; }
        .theme-toggle:hover { background: var(--bg-hover); color: var(--text-primary); }
        .breadcrumb { font-family: var(--font-mono); font-size: 13px; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; }
        .breadcrumb-item { color: var(--text-muted); }
        .breadcrumb-item.active { color: var(--accent-blue); }
        .breadcrumb-separator { color: var(--text-muted); }
        .search-container { flex: 1; max-width: 500px; margin-left: auto; }
        .search-wrapper { position: relative; display: flex; align-items: center; gap: 8px; }
        .search-input { flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 10px 40px 10px 16px; font-family: var(--font-mono); font-size: 13px; color: var(--text-primary); transition: all 0.2s ease; }
        .search-input:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15); }
        .search-input::placeholder { color: var(--text-muted); }
        .search-icon { position: absolute; right: 12px; color: var(--text-muted); pointer-events: none; }
        .search-nav { display: flex; align-items: center; gap: 4px; opacity: 0; transition: opacity 0.2s ease; }
        .search-nav.visible { opacity: 1; }
        .search-counter { font-family: var(--font-mono); font-size: 12px; color: var(--text-secondary); padding: 0 8px; min-width: 70px; text-align: center; }
        .search-btn { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 6px 10px; cursor: pointer; color: var(--text-secondary); transition: all 0.2s ease; }
        .search-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .search-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .clear-search-btn { background: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; display: none; }
        .clear-search-btn.visible { display: block; }
        .content-area { flex: 1; padding: 32px; max-width: 1200px; }
        .nav-group { margin-bottom: 8px; }
        .nav-dropdown { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); overflow: hidden; }
        .nav-dropdown-header { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; transition: background 0.2s ease; user-select: none; }
        .nav-dropdown-header:hover { background: var(--bg-hover); }
        .nav-dropdown-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 14px; transition: transform 0.2s ease; }
        .nav-dropdown.open > .nav-dropdown-header .nav-dropdown-icon { transform: rotate(90deg); }
        .nav-dropdown-title { font-family: var(--font-mono); font-size: 14px; font-weight: 500; color: var(--text-primary); flex: 1; }
        .nav-dropdown-badge { background: var(--accent-blue); color: var(--bg-primary); font-family: var(--font-mono); font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 10px; }
        .nav-dropdown-content { display: none; padding: 4px 8px 8px; }
        .nav-dropdown.open > .nav-dropdown-content { display: block; }
        .nav-dropdown .nav-dropdown { background: transparent; border: none; margin-left: 8px; }
        .nav-dropdown .nav-dropdown .nav-dropdown-header { padding: 8px 12px; border-radius: var(--radius-sm); }
        .nav-item { display: flex; align-items: center; padding: 8px 12px; margin: 2px 0; margin-left: 16px; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s ease; font-family: var(--font-mono); font-size: 13px; color: var(--text-secondary); }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: rgba(88, 166, 255, 0.15); color: var(--accent-blue); }
        .nav-item-emoji { margin-right: 8px; font-size: 14px; }
        .nav-item-name { flex: 1; }
        .nav-item-lock { color: var(--accent-orange); font-size: 12px; }
        .nav-item-unlock { color: var(--accent-green); font-size: 12px; }
        .nav-item.combined { color: var(--accent-purple); font-style: italic; }
        .content-header { margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid var(--border-color); }
        .content-title { font-size: 32px; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; }
        .content-title-emoji { font-size: 28px; }
        .content-meta { font-family: var(--font-mono); font-size: 12px; color: var(--text-muted); }
        .toc-container { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 20px 24px; margin-bottom: 32px; }
        .toc-title { font-family: var(--font-mono); font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .toc-list { list-style: none; columns: 2; column-gap: 32px; }
        .toc-list.single-column { columns: 1; }
        .toc-item { margin: 6px 0; break-inside: avoid; }
        .toc-link { color: var(--text-secondary); text-decoration: none; font-size: 14px; transition: color 0.2s ease; display: inline-flex; align-items: center; gap: 8px; }
        .toc-link:hover { color: var(--accent-blue); }
        .toc-link::before { content: '‚Ä∫'; color: var(--text-muted); }
        .toc-item.level-1 { margin-left: 0; font-weight: 500; }
        .toc-item.level-2 { margin-left: 16px; }
        .toc-item.level-3, .toc-item.level-4, .toc-item.level-5, .toc-item.level-6 { display: none; }
        .toc-group-header { font-family: var(--font-mono); font-size: 11px; font-weight: 600; color: var(--accent-purple); text-transform: uppercase; letter-spacing: 1px; margin: 16px 0 8px; padding: 4px 0; border-bottom: 1px solid var(--border-color); list-style: none; }
        .toc-group-header:first-child { margin-top: 0; }
        .heading-toc-link { color: var(--text-muted); text-decoration: none; font-size: 14px; margin-left: 8px; opacity: 0; transition: opacity 0.2s ease; }
        .markdown-body h1:hover .heading-toc-link, .markdown-body h2:hover .heading-toc-link { opacity: 1; }
        .heading-toc-link:hover { color: var(--accent-blue); }
        .markdown-body { color: var(--text-primary); }
        .markdown-body h1 { font-size: 28px; font-weight: 600; margin: 40px 0 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); scroll-margin-top: 100px; }
        .markdown-body h2 { font-size: 22px; font-weight: 600; margin: 32px 0 12px; color: var(--accent-blue); scroll-margin-top: 100px; }
        .markdown-body h3 { font-size: 18px; font-weight: 600; margin: 24px 0 10px; scroll-margin-top: 100px; }
        .markdown-body h4, .markdown-body h5, .markdown-body h6 { font-size: 16px; font-weight: 600; margin: 20px 0 8px; scroll-margin-top: 100px; }
        .markdown-body p { margin: 16px 0; }
        .markdown-body ul, .markdown-body ol { margin: 16px 0; padding-left: 28px; }
        .markdown-body li { margin: 8px 0; }
        .markdown-body code { font-family: var(--font-mono); font-size: 13px; background: var(--bg-tertiary); padding: 2px 6px; border-radius: var(--radius-sm); color: var(--accent-orange); }
        .markdown-body pre { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 16px; overflow-x: auto; margin: 16px 0; }
        .markdown-body pre code { background: transparent; padding: 0; color: var(--text-primary); }
        .markdown-body blockquote { border-left: 4px solid var(--accent-purple); padding-left: 16px; margin: 16px 0; color: var(--text-secondary); font-style: italic; }
        .markdown-body a { color: var(--accent-blue); text-decoration: none; }
        .markdown-body a:hover { text-decoration: underline; }
        .markdown-body table { width: 100%; border-collapse: collapse; margin: 16px 0; }
        .markdown-body th, .markdown-body td { border: 1px solid var(--border-color); padding: 10px 14px; text-align: left; }
        .markdown-body th { background: var(--bg-tertiary); font-weight: 600; }
        .markdown-body hr { border: none; border-top: 1px solid var(--border-color); margin: 32px 0; }
        .markdown-body tr.filtered-out { display: none; }
        .markdown-body tr.filter-match { background: rgba(88, 166, 255, 0.1); }
        .search-highlight { background: var(--highlight-bg); color: #000; padding: 1px 2px; border-radius: 2px; }
        .search-highlight.active { background: var(--highlight-active); color: #fff; box-shadow: 0 0 0 2px var(--highlight-active); }
        .table-filter-wrapper { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 12px; margin-bottom: 8px; }
        .table-filter-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .table-filter-title { font-family: var(--font-mono); font-size: 11px; font-weight: 600; color: var(--accent-cyan); text-transform: uppercase; letter-spacing: 1px; }
        .table-filter-toggle { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 4px 8px; font-family: var(--font-mono); font-size: 10px; color: var(--text-secondary); cursor: pointer; }
        .table-filter-toggle:hover { background: var(--bg-hover); color: var(--text-primary); }
        .table-filter-rules { display: flex; flex-direction: column; gap: 6px; }
        .filter-rule { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .filter-rule select, .filter-rule input { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 5px 8px; font-family: var(--font-mono); font-size: 11px; color: var(--text-primary); }
        .filter-rule select:focus, .filter-rule input:focus { outline: none; border-color: var(--accent-blue); }
        .filter-rule select { min-width: 100px; }
        .filter-rule input { flex: 1; min-width: 120px; }
        .filter-rule-remove { background: var(--accent-red); border: none; border-radius: var(--radius-sm); padding: 5px 8px; color: #fff; cursor: pointer; font-size: 11px; }
        .filter-rule-remove:hover { filter: brightness(1.2); }
        .filter-actions { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
        .filter-btn { padding: 6px 12px; border-radius: var(--radius-sm); font-family: var(--font-mono); font-size: 11px; cursor: pointer; transition: all 0.2s ease; }
        .filter-add-btn { background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-secondary); }
        .filter-add-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .filter-apply-btn { background: var(--accent-blue); border: none; color: var(--bg-primary); }
        .filter-apply-btn:hover { filter: brightness(1.1); }
        .filter-clear-btn { background: var(--bg-tertiary); border: 1px solid var(--accent-red); color: var(--accent-red); }
        .filter-clear-btn:hover { background: var(--accent-red); color: #fff; }
        .table-copy-wrapper { display: flex; justify-content: flex-end; margin-top: 8px; position: relative; }
        .copy-table-btn { background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 6px 12px; border-radius: var(--radius-sm); font-family: var(--font-mono); font-size: 11px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px; }
        .copy-table-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .copy-table-btn.copied { background: var(--accent-green); border-color: var(--accent-green); color: #fff; }
        .copy-formats-dropdown { position: absolute; top: 100%; right: 0; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-md); box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100; min-width: 150px; display: none; margin-top: 4px; }
        .copy-formats-dropdown.open { display: block; }
        .copy-format-item { padding: 8px 12px; cursor: pointer; transition: all 0.2s ease; border-bottom: 1px solid var(--border-color); font-family: var(--font-mono); font-size: 11px; color: var(--text-secondary); }
        .copy-format-item:last-child { border-bottom: none; }
        .copy-format-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .copy-format-item.copied { background: var(--accent-green); color: #fff; border-bottom-color: var(--accent-green); }
        .media-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
        .media-item { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); overflow: hidden; transition: all 0.3s ease; cursor: pointer; }
        .media-item:hover { border-color: var(--accent-blue); box-shadow: 0 4px 12px rgba(88, 166, 255, 0.1); }
        .media-item-thumbnail { width: 100%; aspect-ratio: 16/9; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; font-size: 48px; color: var(--text-muted); overflow: hidden; position: relative; }
        .media-item-thumbnail img, .media-item-thumbnail video { width: 100%; height: 100%; object-fit: cover; }
        .media-item-content { padding: 16px; }
        .media-item-title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
        .media-item-caption { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; line-height: 1.4; }
        .media-item-subcaption { font-size: 12px; color: var(--text-muted); margin-bottom: 12px; }
        .media-item-lock { display: flex; align-items: center; gap: 8px; padding: 8px; background: rgba(255, 107, 107, 0.1); border-radius: var(--radius-sm); color: var(--accent-red); font-size: 12px; }
        .media-item-lock::before { content: 'üîí'; }
        .media-gallery-header { font-family: var(--font-mono); font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; }
        .filter-logic-select { background: var(--accent-purple) !important; color: #fff !important; border: none !important; font-weight: 600; }
        .filter-results { font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); margin-top: 6px; }
        .password-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .password-overlay.visible { opacity: 1; visibility: visible; }
        .password-modal { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 32px; width: 100%; max-width: 400px; transform: translateY(20px); transition: transform 0.3s ease; }
        .password-overlay.visible .password-modal { transform: translateY(0); }
        .password-icon { font-size: 48px; text-align: center; margin-bottom: 16px; }
        .password-title { font-size: 20px; font-weight: 600; text-align: center; margin-bottom: 8px; }
        .password-subtitle { font-family: var(--font-mono); font-size: 13px; color: var(--text-secondary); text-align: center; margin-bottom: 24px; }
        .password-input-wrapper { margin-bottom: 16px; }
        .password-input { width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 12px 16px; font-family: var(--font-mono); font-size: 14px; color: var(--text-primary); text-align: center; letter-spacing: 4px; }
        .password-input:focus { outline: none; border-color: var(--accent-blue); }
        .password-error { color: var(--accent-red); font-size: 13px; text-align: center; margin-bottom: 16px; display: none; }
        .password-error.visible { display: block; }
        .password-buttons { display: flex; gap: 12px; }
        .password-btn { flex: 1; padding: 12px; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; }
        .password-btn-cancel { background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-secondary); }
        .password-btn-cancel:hover { background: var(--bg-hover); color: var(--text-primary); }
        .password-btn-submit { background: var(--accent-blue); border: none; color: var(--bg-primary); }
        .password-btn-submit:hover { filter: brightness(1.1); }
        .back-to-top { position: fixed; bottom: 32px; right: 32px; width: 48px; height: 48px; background: var(--accent-blue); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--bg-primary); font-size: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); opacity: 0; visibility: hidden; transform: translateY(20px); transition: all 0.3s ease; z-index: 90; }
        .back-to-top.visible { opacity: 1; visibility: visible; transform: translateY(0); }
        .back-to-top:hover { transform: translateY(-4px); }
        .loading-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 64px; color: var(--text-secondary); }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border-color); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 64px; text-align: center; }
        .empty-state-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
        .empty-state-text { color: var(--text-secondary); font-size: 14px; }
        .pyodide-loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-primary); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; transition: opacity 0.5s ease; }
        .pyodide-loading.hidden { opacity: 0; pointer-events: none; }
        .pyodide-logo { font-size: 64px; margin-bottom: 24px; animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .pyodide-text { font-family: var(--font-mono); font-size: 14px; color: var(--text-secondary); margin-bottom: 24px; }
        .pyodide-progress { width: 200px; height: 4px; background: var(--bg-tertiary); border-radius: 2px; overflow: hidden; }
        .pyodide-progress-bar { height: 100%; background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple)); width: 0%; transition: width 0.3s ease; }
        /* Table cell truncation styles */
        .table-cell-truncated { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; position: relative; transition: all 0.2s ease; }
        .table-cell-truncated:hover { background: var(--bg-hover); }
        .truncation-toggle { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 8px 12px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; font-size: 12px; display: flex; align-items: center; gap: 8px; }
        .truncation-toggle:hover { background: var(--bg-hover); color: var(--text-primary); }
        .truncation-toggle.active { background: var(--accent-blue); border-color: var(--accent-blue); color: var(--bg-primary); }
        .pdf-download-btn { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 8px 12px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; font-size: 13px; display: flex; align-items: center; gap: 6px; font-family: var(--font-mono); }
        .pdf-download-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .pdf-download-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .pdf-download-btn.downloading { background: var(--accent-blue); border-color: var(--accent-blue); color: var(--bg-primary); }
        /* Responsive Design - Touch Devices */
        @media (max-width: 1200px) {
            .sidebar { width: 280px; min-width: 280px; }
            .main-content { margin-left: 280px; }
            .content-area { padding: 24px; max-width: 100%; }
            .toc-list { columns: 1; }
        }
        @media (max-width: 1024px) {
            .sidebar { width: 260px; min-width: 260px; }
            .main-content { margin-left: 260px; }
            .content-area { padding: 20px; }
            .top-bar { padding: 12px 20px; gap: 12px; }
        }
        @media (max-width: 768px) {
            /* Layout adjustments */
            .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; width: 280px; }
            .sidebar.open { transform: translateX(0); z-index: 200; box-shadow: 2px 0 8px rgba(0, 0, 0, 0.3); }
            .main-content { margin-left: 0; }
            .content-area { padding: 16px; max-width: 100%; }
            .top-bar { padding: 12px 16px; gap: 8px; }
            .top-bar-left { gap: 12px; }
            .top-bar-right { gap: 8px; }
            
            /* Search container - hide on mobile, show toggle */
            .search-container { display: none; }
            .mobile-menu-btn { display: flex; min-width: 44px; min-height: 44px; }
            
            /* Navigation adjustments */
            .master-toc-container { margin-bottom: 8px; }
            .special-nav-item { padding: 12px; min-height: 44px; }
            .nav-item { padding: 10px 12px; min-height: 44px; margin-left: 12px; }
            .nav-dropdown-header { padding: 10px 12px; min-height: 44px; }
            
            /* Content adjustments */
            .toc-list { columns: 1; }
            .toc-container { padding: 16px; margin-bottom: 24px; }
            .content-title { font-size: 24px; margin-bottom: 4px; }
            .content-header { margin-bottom: 20px; padding-bottom: 16px; }
            
            /* Markdown body */
            .markdown-body h1 { font-size: 22px; margin: 24px 0 12px; }
            .markdown-body h2 { font-size: 18px; margin: 20px 0 10px; }
            .markdown-body h3 { font-size: 16px; margin: 16px 0 8px; }
            .markdown-body h4, .markdown-body h5, .markdown-body h6 { font-size: 14px; margin: 12px 0 6px; }
            .markdown-body p { margin: 12px 0; font-size: 16px; }
            .markdown-body code { font-size: 12px; padding: 2px 4px; }
            .markdown-body pre { padding: 12px; margin: 12px 0; overflow-x: auto; -webkit-overflow-scrolling: touch; }
            
            /* Tables */
            .markdown-body table { font-size: 13px; margin: 12px 0; }
            .markdown-body th, .markdown-body td { padding: 8px 10px; }
            
            /* Buttons and controls */
            .truncation-toggle { min-height: 44px; padding: 10px; font-size: 12px; }
            .theme-toggle { min-height: 44px; min-width: 44px; padding: 8px; }
            .pdf-download-btn { min-height: 44px; padding: 10px; font-size: 12px; }
            .search-btn { min-height: 44px; min-width: 44px; padding: 10px; }
            
            /* Filter and table controls */
            .table-filter-wrapper { padding: 10px; margin-bottom: 8px; }
            .filter-rule { gap: 8px; }
            .filter-rule select, .filter-rule input { padding: 8px 6px; font-size: 12px; min-height: 40px; }
            .filter-btn { min-height: 40px; padding: 8px 10px; font-size: 11px; }
            .copy-table-btn { min-height: 40px; padding: 8px 10px; }
            
            /* Modal adjustments */
            .password-modal { padding: 24px; max-width: 90%; }
            .password-input { padding: 12px; font-size: 16px; }
            .password-btn { padding: 12px; min-height: 44px; font-size: 14px; }
            
            /* Media gallery */
            .media-gallery { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
            .media-item-title { font-size: 14px; }
            .media-item-caption { font-size: 12px; }
        }
        @media (max-width: 600px) {
            /* Extra small screens */
            .sidebar { width: 100%; max-width: 280px; }
            .sidebar-header { padding: 16px; }
            .sidebar-title { font-size: 13px; }
            .sidebar-logo { font-size: 12px; }
            
            .content-area { padding: 12px; }
            .top-bar { padding: 10px 12px; }
            .breadcrumb { font-size: 11px; display: none; }
            
            /* Content */
            .content-title { font-size: 20px; gap: 8px; }
            .content-title-emoji { font-size: 24px; }
            .content-meta { font-size: 10px; }
            
            /* Typography */
            .markdown-body h1 { font-size: 18px; margin: 16px 0 8px; padding-bottom: 8px; }
            .markdown-body h2 { font-size: 16px; margin: 12px 0 6px; }
            .markdown-body h3 { font-size: 14px; margin: 10px 0 4px; }
            .markdown-body p { font-size: 14px; margin: 8px 0; }
            .markdown-body ul, .markdown-body ol { padding-left: 20px; margin: 8px 0; }
            .markdown-body li { margin: 4px 0; }
            
            /* Tables - horizontal scroll */
            .markdown-body table { font-size: 12px; display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; white-space: nowrap; }
            .markdown-body th, .markdown-body td { padding: 6px 8px; }
            
            /* Buttons */
            .truncation-toggle { padding: 8px; font-size: 11px; }
            .pdf-download-btn { padding: 8px 10px; font-size: 11px; }
            
            /* TOC */
            .toc-container { padding: 12px; margin-bottom: 16px; }
            .toc-title { font-size: 10px; margin-bottom: 8px; }
            .toc-link { font-size: 12px; }
        }
        @media (max-width: 480px) {
            /* Phones */
            .main-content { margin-left: 0; }
            .content-area { padding: 8px; }
            .top-bar { padding: 8px 10px; gap: 4px; }
            .top-bar-right { gap: 4px; }
            
            /* Hide less important buttons on very small screens */
            .pdf-download-btn span:last-child { display: none; }
            .pdf-download-btn { padding: 8px; }
            
            .content-title { font-size: 18px; margin-bottom: 2px; }
            .content-title-emoji { font-size: 20px; }
            
            /* Navigation */
            .special-nav-item { font-size: 12px; padding: 10px; }
            .nav-item { font-size: 12px; padding: 8px; margin-left: 8px; }
            
            /* Markdown */
            .markdown-body h1 { font-size: 16px; margin: 12px 0 6px; }
            .markdown-body h2 { font-size: 14px; margin: 10px 0 4px; }
            .markdown-body h3 { font-size: 12px; margin: 8px 0 2px; }
            .markdown-body p { font-size: 13px; margin: 6px 0; line-height: 1.5; }
            .markdown-body code { font-size: 11px; }
            .markdown-body pre { padding: 8px; font-size: 11px; }
            
            .markdown-body table { font-size: 11px; }
            .markdown-body th, .markdown-body td { padding: 4px 6px; }
            
            /* TOC */
            .toc-list { columns: 1; }
            .toc-item { margin: 3px 0; }
            .toc-link { font-size: 11px; }
            
            /* Blocks */
            .markdown-body blockquote { padding-left: 12px; margin: 8px 0; }
            .markdown-body hr { margin: 16px 0; }
        }
        @media (touch-enabled), (hover: none) {
            /* Touch-friendly adjustments */
            .nav-item:hover { transform: none; background: var(--bg-hover); }
            .special-nav-item:hover { transform: none; background: var(--bg-hover); opacity: 0.8; }
            .toc-link:hover { background: var(--bg-tertiary); }
            .markdown-body a { padding: 2px 2px; border-radius: 2px; }
            .markdown-body a:active { background: var(--highlight-bg); }
            .search-btn { -webkit-user-select: none; user-select: none; }
            .copy-table-btn { -webkit-user-select: none; user-select: none; }
        }
        .mobile-menu-btn { display: none; background: transparent; border: none; color: var(--text-primary); font-size: 24px; cursor: pointer; padding: 4px; }
        /* Protection styles: disable selection, image/link interaction and printing for protected content */
        .nav-item-protect { margin-left: 6px; font-size: 12px; color: var(--accent-purple); }
        .protected-content { user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
        .protected-content img, .protected-content video { pointer-events: none; -webkit-user-drag: none; }
        .protected-content a { pointer-events: none; color: inherit; text-decoration: none; }
        .protected-print-notice { display: none; font-family: var(--font-mono); font-size: 13px; color: var(--accent-red); padding: 8px 0; }
        @media print { 
            .protected-content { display: none !important; } 
            .protected-print-notice { display: block !important; }
            .table-filter-wrapper { display: none !important; }
            .top-bar { display: none !important; }
            .sidebar { display: none !important; }
            .main-content { margin-left: 0 !important; }
        }
    </style>
</head>
<body>
    <div class="pyodide-loading" id="pyodideLoading">
        <div class="pyodide-logo">üìö</div>
        <div class="pyodide-text">Initializing Markdown Engine...</div>
        <div class="pyodide-progress"><div class="pyodide-progress-bar" id="pyodideProgress"></div></div>
    </div>
    <div class="password-overlay" id="passwordOverlay">
        <div class="password-modal">
            <div class="password-icon">üîê</div>
            <div class="password-title">Protected Note</div>
            <div class="password-subtitle" id="passwordNoteTitle">Enter password to unlock</div>
            <div class="password-input-wrapper"><input type="password" class="password-input" id="passwordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
            <div class="password-error" id="passwordError">Incorrect password. Please try again.</div>
            <div class="password-buttons">
                <button class="password-btn password-btn-cancel" id="passwordCancel">Cancel</button>
                <button class="password-btn password-btn-submit" id="passwordSubmit">Unlock</button>
            </div>
        </div>
    </div>
    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">üìñ Notes</div>
                <div class="sidebar-title">Compiled by: <br>‡§∂‡§ø‡§µ‡§™‡•ç‡§∞‡§∏‡§æ‡§¶ ‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø<br>M.Sc;LL.M <br>(‡§µ‡§∏‡§®‡•ç‡§§‡§™‡§û‡•ç‡§ö‡§Æ‡§ø,‡•®‡•¶‡•Æ‡•®)</div>
            </div>
            <nav class="nav-container" id="navContainer">
                <div class="special-nav-item readme-item" id="readmeItem" style="display: none;"><span class="special-nav-item-emoji">üìò</span><span>README.md</span></div>
                <div class="special-nav-item public-all-item" id="publicAllItem"><span class="special-nav-item-emoji">üåê</span><span>Public All Notes</span></div>
                <div class="master-toc-container" id="masterTocContainer">
                    <div class="master-toc-header" id="masterTocHeader"><span class="master-toc-icon">‚ñ∂</span><span class="master-toc-title">üìã Master TOC</span></div>
                    <div class="master-toc-content" id="masterTocContent"></div>
                </div>
            </nav>
        </aside>
        <main class="main-content">
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
                    <div class="breadcrumb" id="breadcrumb"><span class="breadcrumb-item">Notes</span></div>
                </div>
                <div class="search-container">
                    <div class="search-wrapper">
                        <input type="text" class="search-input" id="searchInput" placeholder="Search in content... (Ctrl+F)">
                        <span class="search-icon">üîç</span>
                        <button class="clear-search-btn" id="clearSearch">‚úï</button>
                    </div>
                    <div class="search-nav" id="searchNav">
                        <button class="search-btn" id="searchPrev" disabled>‚ñ≤</button>
                        <span class="search-counter" id="searchCounter">0 / 0</span>
                        <button class="search-btn" id="searchNext" disabled>‚ñº</button>
                    </div>
                </div>
                <div class="top-bar-right">
                    <button class="pdf-download-btn" id="pdfDownloadBtn" title="Download as PDF">üì• PDF</button>
                    <button class="truncation-toggle" id="truncationToggle" title="Toggle table cell truncation">üìã Full Text</button>
                    <button class="theme-toggle" id="themeToggle" title="Toggle light/dark mode">üåô</button>
                </div>
            </header>
            <article class="content-area" id="contentArea">
                <div class="empty-state">
                    <div class="empty-state-icon">üìÑ</div>
                    <div class="empty-state-title">Select a Note</div>
                    <div class="empty-state-text">Choose a note from the sidebar to view its content</div>
                </div>
            </article>
        </main>
    </div>
    <button class="back-to-top" id="backToTop">‚¨Ü</button>
    <script>
// ========================================
// Sample Data
// ========================================
window.readmeContent = `# üìö Markdown Notes Viewer\n\nWelcome to the Markdown Notes Viewer!\n\n## Features\n\n- Multi-level nested navigation\n- Password-protected notes\n- Combined views (U0, U01)\n- Public All Notes view\n- Advanced table filtering\n- Nepali/Devanagari search\n\n## Usage\n\nClick notes in the sidebar to view them.`;
window.readmeMeta = { name: "README", emoji: "üìò", password: null, protection: "NO" };

window.groupUMeta = { name: "JavaScript & React", emoji: "üü®", description: "Frontend docs" };
window.groupVMeta = { name: "Python & Data", emoji: "üêç", description: "Backend docs" };
window.groupWMeta = { name: "Nepali Content", emoji: "üá≥üáµ", description: "‡§®‡•á‡§™‡§æ‡§≤‡•Ä" };
window.unitU1Meta = { name: "JS Fundamentals", emoji: "üìó", description: "Core JS" };
window.unitU2Meta = { name: "React Development", emoji: "‚öõÔ∏è", description: "React" };
window.unitV1Meta = { name: "Python Basics", emoji: "üêç", description: "Python" };
window.unitV2Meta = { name: "Data Science", emoji: "üìä", description: "Data" };
window.unitW1Meta = { name: "‡§®‡•á‡§™‡§æ‡§≤‡•Ä", emoji: "üìú", description: "Nepali" };
window.combinedU0Meta = { name: "All JS & React", emoji: "üü®", description: "All Group U" };
window.combinedV0Meta = { name: "All Python", emoji: "üêç", description: "All Group V" };
window.combinedW0Meta = { name: "All Nepali", emoji: "üá≥üáµ", description: "All Group W" };
window.combinedU01Meta = { name: "JS Collection", emoji: "üìó", description: "Unit U1" };
window.combinedU02Meta = { name: "React Collection", emoji: "‚öõÔ∏è", description: "Unit U2" };
window.combinedV01Meta = { name: "Python Collection", emoji: "üêç", description: "Unit V1" };
window.combinedV02Meta = { name: "Data Collection", emoji: "üìä", description: "Unit V2" };
window.publicAllMeta = { name: "Public All Notes", emoji: "üåê", description: "All public notes" };

window.noteU11Content = `# Introduction to JavaScript\n\n## Overview\nJavaScript is versatile.\n\n## Features Table\n\n| Feature | Type | Supported |\n|---------|------|----------|\n| Variables | let/const | Yes ‡•ß‡•® ‡§Æ‡§æ‡§ò, ‡§ï‡§æ‡§†‡§Æ‡§æ‡§°‡•å‡§Ç ‡•§ ‡§∏‡•Å‡§®‡§∏‡§∞‡•Ä-‡•ß ‡§ï‡§æ ‡§â‡§Æ‡•ç‡§Æ‡•á‡§¶‡§µ‡§æ‡§∞ ‡§π‡§∞‡•ç‡§ï ‡§∏‡§æ‡§Æ‡•ç‡§™‡§æ‡§ô‡§µ‡§ø‡§∞‡•Å‡§¶‡•ç‡§ß ‡§®‡§ø‡§∞‡•ç‡§µ‡§æ‡§ö‡§® ‡§Ü‡§Ø‡•ã‡§ó‡§Æ‡§æ ‡§â‡§ú‡•Å‡§∞‡•Ä ‡§™‡§∞‡•á‡§ï‡•ã ‡§õ ‡•§ ‡§∂‡•ç‡§∞‡§Æ ‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§ø ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä‡§ï‡§æ ‡§Ö‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑‡§∏‡§Æ‡•á‡§§ ‡§∞‡§π‡•á‡§ï‡§æ ‡§∏‡§æ‡§Æ‡•ç‡§™‡§æ‡§ô‡§≤‡•á ‡§ö‡•Å‡§®‡§æ‡§µ‡•Ä ‡§™‡•ç‡§∞‡§ö‡§æ‡§∞‡§™‡•ç‡§∞‡§ö‡§æ‡§∞‡§Æ‡§æ ‡§¨‡§æ‡§≤‡§¨‡§æ‡§≤‡§ø‡§ï‡§æ‡§ï‡•ã ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ó‡§∞‡•á‡§ï‡•ã ‡§Ü‡§∞‡•ã‡§™‡§Æ‡§æ ‡§â‡§ú‡•Å‡§∞‡•Ä ‡§™‡§∞‡•á‡§ï‡•ã ‡§π‡•ã ‡•§ <br>‡•ß‡•® ‡§Æ‡§æ‡§ò, ‡§ï‡§æ‡§†‡§Æ‡§æ‡§°‡•å‡§Ç ‡•§ ‡§∏‡•Å‡§®‡§∏‡§∞‡•Ä-‡•ß ‡§ï‡§æ ‡§â‡§Æ‡•ç‡§Æ‡•á‡§¶‡§µ‡§æ‡§∞ ‡§π‡§∞‡•ç‡§ï ‡§∏‡§æ‡§Æ‡•ç‡§™‡§æ‡§ô‡§µ‡§ø‡§∞‡•Å‡§¶‡•ç‡§ß ‡§®‡§ø‡§∞‡•ç‡§µ‡§æ‡§ö‡§® ‡§Ü‡§Ø‡•ã‡§ó‡§Æ‡§æ ‡§â‡§ú‡•Å‡§∞‡•Ä ‡§™‡§∞‡•á‡§ï‡•ã ‡§õ ‡•§ ‡§∂‡•ç‡§∞‡§Æ ‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§ø ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä‡§ï‡§æ ‡§Ö‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑‡§∏‡§Æ‡•á‡§§ ‡§∞‡§π‡•á‡§ï‡§æ ‡§∏‡§æ‡§Æ‡•ç‡§™‡§æ‡§ô‡§≤‡•á ‡§ö‡•Å‡§®‡§æ‡§µ‡•Ä ‡§™‡•ç‡§∞‡§ö‡§æ‡§∞‡§™‡•ç‡§∞‡§ö‡§æ‡§∞‡§Æ‡§æ ‡§¨‡§æ‡§≤‡§¨‡§æ‡§≤‡§ø‡§ï‡§æ‡§ï‡•ã ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ó‡§∞‡•á‡§ï‡•ã ‡§Ü‡§∞‡•ã‡§™‡§Æ‡§æ ‡§â‡§ú‡•Å‡§∞‡•Ä ‡§™‡§∞‡•á‡§ï‡•ã ‡§π‡•ã ‡•§|\n| Functions | Arrow | Yes |\n| Classes | ES6 | Yes |\n| Modules | ESM | Yes |\n| Async | Promise | Yes |`;
window.noteU11Meta = { name: "JS Basics", emoji: "üìí", password: null, protection: "NO" };

window.noteU12Content = `# Advanced JavaScript\n\n## Closures\nClosures capture scope.\n\n## Performance\n\n| Method | Speed | Memory |\n|--------|-------|--------|\n| Callbacks | Fast | Low |\n| Promises | Medium | Medium |\n| Async/Await | Medium | Medium |`;
window.noteU12Meta = { name: "JS Advanced", emoji: "üìó", password: null, protection: "YES" };

window.noteU13Content = `# Security Patterns (Locked)\n\n## Auth Table\n\n| Method | Level |\n|--------|-------|\n| JWT | High |\n| OAuth | Very High |`;
window.noteU13Meta = { name: "Security", emoji: "üîí", password: "secret123", protection: "YES" };

window.noteU21Content = `# React Fundamentals\n\n## Components\nBuilding blocks of React.\n\n## Comparison\n\n| Feature | Class | Functional |\n|---------|-------|------------|\n| State | this.state | useState |\n| Lifecycle | methods | useEffect |\n\n## Resources\n\n| Resource | Link | Type |\n|----------|------|------|\n| Official Docs | https://react.dev | External |\n| Tutorial | https://react.dev/learn | External |\n| Community | https://github.com/facebook/react | Repository |`;
window.noteU21Meta = { name: "React Basics", emoji: "‚öõÔ∏è", password: null, protection: "YES" };

window.noteU22Content = `# State Management\n\n## Solutions\n\n| Library | Size | Learning |\n|---------|------|----------|\n| Redux | Large | Steep |\n| MobX | Medium | Medium |\n| Zustand | Small | Easy |\n\n## Gallery\n\n| Title | Caption | Subcaption | URL |\n|-------|---------|------------|-----|\n| React Logo | Official React brand | Modern UI library | https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/React-icon.svg/1024px-React-icon.svg.png |\n| Vue Framework | Progressive framework | Alternative to React | https://vuejs.org/images/logo.png |\n| Angular Icon | Google framework | Complete solution | https://angular.io/assets/images/logos/angular/angular.svg |`;
window.noteU22Meta = { name: "State Mgmt", emoji: "üîÑ", password: "123", protection: "YES" };

window.noteV11Content = `# Python Basics\n\n## Comparison\n\n| Feature | Python | Java |\n|---------|--------|------|\n| Typing | Dynamic | Static |\n| Syntax | Clean | Verbose |`;
window.noteV11Meta = { name: "Python Intro", emoji: "üêç", password: null, protection: "NO" };

window.noteV12Content = `# Python OOP\n\n## Concepts\n\n| Concept | Description |\n|---------|-------------|\n| Encapsulation | Data hiding |\n| Inheritance | Code reuse |`;
window.noteV12Meta = { name: "Python OOP", emoji: "üéØ", password: null, protection: "NO" };

window.noteV13Content = `# API Keys (Locked)\n\n## Keys\n\n| Env | Level |\n|-----|-------|\n| Prod | Full |`;
window.noteV13Meta = { name: "API Keys", emoji: "üîê", password: "123", protection: "YES" };

window.noteV21Content = `# Data Science\n\n## Libraries\n\n| Library | Purpose | Performance |\n|---------|---------|-------------|\n| NumPy | Arrays | Excellent |\n| Pandas | DataFrames | Good |\n| Matplotlib | Plotting | Good |`;
window.noteV21Meta = { name: "Data Science", emoji: "üìä", password: null, protection: "NO" };

window.noteW11Content = `# ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§≠‡§æ‡§∑‡§æ\n\n## ‡§∂‡§ø‡§µ ‡§ï‡•ã ‡§ï‡§•‡§æ\n‡§∂‡§ø‡§µ ‡§¶‡•á‡§µ‡§§‡§æ ‡§π‡•Å‡§®‡•ç‡•§ ‡§∏‡•Ä‡§µ ‡§™‡§®‡§ø ‡§≠‡§®‡§ø‡§®‡•ç‡§õ‡•§\n\n## ‡§∂‡§¨‡•ç‡§¶ ‡§§‡§æ‡§≤‡§ø‡§ï‡§æ\n\n| ‡§∂‡§¨‡•ç‡§¶ | ‡§Ö‡§∞‡•ç‡§• |\n|------|------|\n| ‡§∂‡§ø‡§µ | ‡§¶‡•á‡§µ‡§§‡§æ |\n| ‡§µ‡§ø‡§ï‡§æ‡§∏ | Progress |`;
window.noteW11Meta = { name: "‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§≠‡§æ‡§∑‡§æ", emoji: "üá≥üáµ", password: null, protection: "NO" };

window.noteW12Content = `# ‡§¶‡•á‡§µ‡§®‡§æ‡§ó‡§∞‡•Ä\n\n## ‡§µ‡§∞‡•ç‡§£‡§Æ‡§æ‡§≤‡§æ\n‡§ï ‡§ñ ‡§ó ‡§ò ‡§ô\n\n## ‡§§‡§æ‡§≤‡§ø‡§ï‡§æ\n\n| ‡§µ‡§∞‡•ç‡§ó | ‡§µ‡§∞‡•ç‡§£‡§π‡§∞‡•Ç |\n|------|--------|\n| ‡§ï ‡§µ‡§∞‡•ç‡§ó | ‡§ï ‡§ñ ‡§ó ‡§ò ‡§ô |`;
window.noteW12Meta = { name: "‡§¶‡•á‡§µ‡§®‡§æ‡§ó‡§∞‡•Ä", emoji: "üìú", password: null, protection: "NO" };
    </script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
// ========================================
// Application State
// ========================================
const AppState = {
    pyodide: null, notes: new Map(), groups: new Map(), groupMeta: new Map(),
    unitMeta: new Map(), combinedMeta: new Map(), currentNote: null,
    unlockedNotes: new Set(), searchMatches: [], currentMatchIndex: -1, currentProtected: false,
    originalContent: '', hasReadme: false, combinedViewHeadingMap: {},
    headingIdMap: {}, headingCounter: 0, truncateTableCells: true, allTableCells: []
};

// ========================================
// PDF Download Manager
// ========================================
const PDFDownloadManager = {
    init() {
        const btn = document.getElementById('pdfDownloadBtn');
        if (btn) {
            btn.addEventListener('click', () => this.downloadPDF());
        }
    },
    async downloadPDF() {
        const btn = document.getElementById('pdfDownloadBtn');
        const contentArea = document.getElementById('contentArea');
        const markdownBody = document.getElementById('markdownBody');
        
        if (!markdownBody) {
            alert('No content to download');
            return;
        }
        
        btn.disabled = true;
        btn.classList.add('downloading');
        const originalText = btn.textContent;
        btn.textContent = '‚è≥ Generating...';
        
        try {
            // Create a temporary style element for PDF-specific styling
            const pdfStyleId = 'pdf-temp-styles';
            let pdfStyle = document.getElementById(pdfStyleId);
            if (!pdfStyle) {
                pdfStyle = document.createElement('style');
                pdfStyle.id = pdfStyleId;
                pdfStyle.textContent = `
                    @media print {
                        .markdown-body h1 { font-size: 18px !important; font-weight: 700 !important; margin: 16px 0 8px !important; padding-bottom: 8px !important; border-bottom: 2px solid #000 !important; }
                        .markdown-body h2 { font-size: 16px !important; font-weight: 700 !important; margin: 14px 0 8px !important; color: #000 !important; }
                        .markdown-body h3 { font-size: 14px !important; font-weight: 700 !important; margin: 12px 0 6px !important; }
                        .markdown-body h4, .markdown-body h5, .markdown-body h6 { font-size: 13px !important; font-weight: 700 !important; margin: 10px 0 6px !important; }
                        .markdown-body { color: #000 !important; font-size: 12px !important; line-height: 1.6 !important; }
                        .markdown-body p { margin: 8px 0 !important; }
                        .markdown-body a { color: #0366d6 !important; }
                        .markdown-body table { font-size: 11px !important; }
                        .markdown-body code { background: #f6f8fa !important; color: #24292e !important; }
                        .markdown-body pre { background: #f6f8fa !important; color: #24292e !important; }
                    }
                `;
                document.head.appendChild(pdfStyle);
            }
            
            // Save original display states
            const topBar = document.querySelector('.top-bar');
            const tableFilters = document.querySelectorAll('.table-filter-wrapper');
            const tocContainer = document.getElementById('toc-container');
            const sidebar = document.getElementById('sidebar');
            
            const savedStates = {
                topBar: topBar ? topBar.style.display : '',
                sidebar: sidebar ? sidebar.style.display : '',
                tocContainer: tocContainer ? tocContainer.style.display : '',
                filters: []
            };
            
            tableFilters.forEach(filter => {
                savedStates.filters.push(filter.style.display);
                filter.style.display = 'none';
            });
            
            // Hide elements for PDF
            if (topBar) topBar.style.display = 'none';
            if (tocContainer) tocContainer.style.display = 'none';
            if (sidebar) sidebar.style.display = 'none';
            
            // Get the title for the PDF filename
            const titleEl = contentArea.querySelector('.content-title');
            const titleText = titleEl ? titleEl.textContent.trim().substring(1).trim() : 'Document';
            const filename = `${titleText.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${new Date().toISOString().split('T')[0]}.pdf`;
            
            // Configure html2pdf options with improved quality settings
            const opt = {
                margin: 10,
                filename: filename,
                image: { type: 'png', quality: 1 },
                html2canvas: { scale: 1, useCORS: true, allowTaint: true, logging: false, backgroundColor: '#ffffff' },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4', compress: false }
            };
            
            // Generate PDF from the actual contentArea in the DOM
            await html2pdf().set(opt).from(contentArea).save();
            
            // Restore original display states
            if (topBar) topBar.style.display = savedStates.topBar;
            if (tocContainer) tocContainer.style.display = savedStates.tocContainer;
            if (sidebar) sidebar.style.display = savedStates.sidebar;
            tableFilters.forEach((filter, idx) => {
                filter.style.display = savedStates.filters[idx];
            });
            
            // Remove temporary style
            if (pdfStyle && pdfStyle.parentNode) {
                pdfStyle.parentNode.removeChild(pdfStyle);
            }
            
            btn.textContent = '‚úì Done!';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.classList.remove('downloading');
            }, 1500);
        } catch (error) {
            console.error('PDF generation error:', error);
            alert('Error generating PDF: ' + error.message);
            btn.textContent = originalText;
            btn.disabled = false;
            btn.classList.remove('downloading');
        }
    }
};

// ========================================
// Theme Management
// ========================================
const ThemeManager = {
    init() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        this.setTheme(savedTheme);
        document.getElementById('themeToggle').addEventListener('click', () => this.toggle());
    },
    setTheme(theme) {
        if (theme === 'light') {
            document.body.classList.add('light-mode');
            localStorage.setItem('theme', 'light');
            document.getElementById('themeToggle').textContent = 'üåû';
            document.getElementById('themeToggle').title = 'Switch to dark mode';
        } else {
            document.body.classList.remove('light-mode');
            localStorage.setItem('theme', 'dark');
            document.getElementById('themeToggle').textContent = 'üåô';
            document.getElementById('themeToggle').title = 'Switch to light mode';
        }
    },
    toggle() {
        const isDark = !document.body.classList.contains('light-mode');
        this.setTheme(isDark ? 'light' : 'dark');
    }
};

// ========================================
// Truncation Management
// ========================================
const TruncationManager = {
    init() {
        const savedTruncate = localStorage.getItem('truncateTableCells');
        AppState.truncateTableCells = savedTruncate !== 'false';
        const btn = document.getElementById('truncationToggle');
        this.updateUI();
        btn.addEventListener('click', () => this.toggle());
    },
    toggle() {
        AppState.truncateTableCells = !AppState.truncateTableCells;
        localStorage.setItem('truncateTableCells', AppState.truncateTableCells);
        this.updateUI();
        this.applyToAllTables();
    },
    updateUI() {
        const btn = document.getElementById('truncationToggle');
        if (AppState.truncateTableCells) {
            btn.textContent = 'üìã Full Text';
            btn.classList.remove('active');
        } else {
            btn.textContent = 'üìã Truncated';
            btn.classList.add('active');
        }
    },
    applyToAllTables() {
        const body = document.getElementById('markdownBody');
        if (!body) return;
        body.querySelectorAll('table').forEach(table => {
            table.querySelectorAll('td').forEach(cell => {
                this.applyToCell(cell);
            });
        });
    },
    applyToCell(cell) {
        if (AppState.truncateTableCells) {
            cell.classList.add('table-cell-truncated');
        } else {
            cell.classList.remove('table-cell-truncated');
        }
    }
};

// ========================================
// Nepali Normalizer
// ========================================
const NepaliNormalizer = {
    vowelMap: { '‡•Ä': '‡§ø', '‡•Ç': '‡•Å' },
    sibilantMap: { '‡§∂': '‡§∏', '‡§∑': '‡§∏' },
    nasalMap: { '‡§ô': '‡§®', '‡§£': '‡§®', '‡§û': '‡§®', '‡§Ç': '‡§®‡•ç' },
    vaBaMap: { '‡§µ': '‡§¨' },
    normalize(text) {
        if (!text) return '';
        let n = text.normalize('NFC').replace(/\u200D/g, '').replace(/\u200C/g, '');
        for (const [f, t] of Object.entries(this.vowelMap)) n = n.split(f).join(t);
        for (const [f, t] of Object.entries(this.sibilantMap)) n = n.split(f).join(t);
        for (const [f, t] of Object.entries(this.nasalMap)) n = n.split(f).join(t);
        for (const [f, t] of Object.entries(this.vaBaMap)) n = n.split(f).join(t);
        return n;
    },
    isDevanagari(text) { return /[\u0900-\u097F]/.test(text); },
    mapToOriginal(normPos, original, normalized) {
        if (normPos <= 0) return 0;
        if (normPos >= normalized.length) return original.length;
        let origIdx = 0, normIdx = 0;
        while (normIdx < normPos && origIdx < original.length) {
            if (original[origIdx] === '\u200D' || original[origIdx] === '\u200C') { origIdx++; continue; }
            origIdx++; normIdx++;
        }
        while (origIdx < original.length && (original[origIdx] === '\u200D' || original[origIdx] === '\u200C')) origIdx++;
        return origIdx;
    }
};

// ========================================
// Discovery & Init
// ========================================
function discoverNotes() {
    const notePattern = /^note([A-Z])(\d)(\d)Content$/;
    if (window.readmeContent) AppState.hasReadme = true;
    for (const key of Object.keys(window)) {
        if (key.match(/^group([A-Z])Meta$/)) AppState.groupMeta.set(key.match(/^group([A-Z])Meta$/)[1], window[key]);
        if (key.match(/^unit([A-Z])(\d)Meta$/)) { const m = key.match(/^unit([A-Z])(\d)Meta$/); AppState.unitMeta.set(`${m[1]}${m[2]}`, window[key]); }
        if (key.match(/^combined([A-Z])(\d+)Meta$/)) { const m = key.match(/^combined([A-Z])(\d+)Meta$/); AppState.combinedMeta.set(`${m[1]}${m[2]}`, window[key]); }
    }
    for (const key of Object.keys(window)) {
        const match = key.match(notePattern);
        if (match) {
            const [, group, unit, noteNum] = match;
            const noteId = `${group}${unit}${noteNum}`;
            const meta = window[`note${noteId}Meta`] || { name: noteId, emoji: 'üìÑ', password: null };
            AppState.notes.set(noteId, { id: noteId, group, unit: parseInt(unit), noteNum: parseInt(noteNum), content: window[key], meta });
            if (!AppState.groups.has(group)) AppState.groups.set(group, new Map());
            if (!AppState.groups.get(group).has(parseInt(unit))) AppState.groups.get(group).set(parseInt(unit), []);
            AppState.groups.get(group).get(parseInt(unit)).push(noteId);
        }
    }
    for (const [g, units] of AppState.groups) for (const [u, notes] of units) notes.sort((a, b) => AppState.notes.get(a).noteNum - AppState.notes.get(b).noteNum);
}

async function initPyodide() {
    const bar = document.getElementById('pyodideProgress'), overlay = document.getElementById('pyodideLoading');
    try {
        bar.style.width = '20%';
        AppState.pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/" });
        bar.style.width = '60%';
        await AppState.pyodide.loadPackage('micropip');
        await AppState.pyodide.pyimport('micropip').install('markdown');
        bar.style.width = '100%';
        await AppState.pyodide.runPythonAsync(`import markdown\ndef convert_markdown(text):\n    md = markdown.Markdown(extensions=['toc','fenced_code','tables','nl2br'])\n    return {'html': md.convert(text), 'toc': md.toc}`);
        setTimeout(() => overlay.classList.add('hidden'), 500);
        return true;
    } catch (e) {
        console.error('Pyodide failed:', e);
        overlay.querySelector('.pyodide-text').textContent = 'Using fallback...';
        setTimeout(() => overlay.classList.add('hidden'), 1000);
        return false;
    }
}

async function renderMarkdown(content) {
    if (AppState.pyodide) {
        try {
            AppState.pyodide.globals.set('markdown_input', content);
            return (await AppState.pyodide.runPythonAsync(`convert_markdown(markdown_input)`)).toJs();
        } catch (e) { return fallbackRender(content); }
    }
    return fallbackRender(content);
}

function fallbackRender(content) {
    let html = content.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/^#### (.+)$/gm, '<h4>$1</h4>').replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>').replace(/^# (.+)$/gm, '<h1>$1</h1>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
        .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
        .replace(/^- (.+)$/gm, '<li>$1</li>').replace(/^---$/gm, '<hr>');
    return { html, toc: '' };
}

// ========================================
// Navigation
// ========================================
function buildNavigation() {
    const nav = document.getElementById('navContainer'), readme = document.getElementById('readmeItem'),
          publicAll = document.getElementById('publicAllItem'), masterToc = document.getElementById('masterTocContainer');
    nav.innerHTML = '';
    if (AppState.hasReadme) { readme.style.display = 'flex'; nav.appendChild(readme); }
    nav.appendChild(publicAll);
    nav.appendChild(masterToc);
    for (const group of Array.from(AppState.groups.keys()).sort()) nav.appendChild(createGroupDropdown(group));
    buildMasterTOC();
}

function getGroupMeta(g) { return AppState.groupMeta.get(g) || { name: `Group ${g}`, emoji: 'üìÅ', description: '' }; }
function getUnitMeta(g, u) { return AppState.unitMeta.get(`${g}${u}`) || { name: `Unit ${g}${u}`, emoji: 'üìÇ', description: '' }; }
function getCombinedMeta(k) { return AppState.combinedMeta.get(k) || { name: k, emoji: 'üìö', description: '' }; }

function extractHeadings(content) {
    const h = [], re = /^(#{1,2}) (.+)$/gm; let m;
    while ((m = re.exec(content)) !== null) h.push({ level: m[1].length, text: m[2].trim(), id: m[2].toLowerCase().replace(/[^a-z0-9\u0900-\u097F]+/g, '-').replace(/^-|-$/g, '') });
    return h;
}

function buildMasterTOC() {
    const c = document.getElementById('masterTocContent'); c.innerHTML = '';
    for (const group of Array.from(AppState.groups.keys()).sort()) {
        for (const unit of Array.from(AppState.groups.get(group).keys()).sort((a, b) => a - b)) {
            for (const noteId of AppState.groups.get(group).get(unit)) {
                const note = AppState.notes.get(noteId);
                if (note.meta.password !== null && !AppState.unlockedNotes.has(noteId)) continue;
                const headings = extractHeadings(note.content);
                if (headings.length === 0) continue;
                const div = document.createElement('div'); div.className = 'master-toc-note'; div.dataset.noteId = noteId;
                const title = document.createElement('div'); title.className = 'master-toc-note-title';
                title.innerHTML = `<span>${note.meta.emoji}</span> ${note.meta.name}`;
                title.addEventListener('click', () => loadNote(noteId)); div.appendChild(title);
                for (const h of headings) {
                    const link = document.createElement('a'); link.className = `master-toc-heading level-${h.level}`;
                    link.textContent = h.text; link.href = '#';
                    link.addEventListener('click', e => { e.preventDefault(); loadNoteAndScrollToHeading(noteId, h.id); });
                    div.appendChild(link);
                }
                c.appendChild(div);
            }
        }
    }
    if (c.children.length === 0) c.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:8px;">No public notes</div>';
}

function createGroupDropdown(group) {
    const gm = getGroupMeta(group), cm = getCombinedMeta(`${group}0`);
    const wrap = document.createElement('div'); wrap.className = 'nav-group';
    const dd = document.createElement('div'); dd.className = 'nav-dropdown';
    dd.innerHTML = `<div class="nav-dropdown-header"><span class="nav-dropdown-icon">‚ñ∂</span><span class="nav-dropdown-title">${gm.emoji} ${gm.name}</span><span class="nav-dropdown-badge">${countPublicNotes(group)}</span></div><div class="nav-dropdown-content"><div class="nav-item combined" data-combined="${group}0"><span class="nav-item-emoji">${cm.emoji}</span><span class="nav-item-name">${group}0 - ${cm.name}</span></div></div>`;
    const content = dd.querySelector('.nav-dropdown-content');
    for (const unit of Array.from(AppState.groups.get(group).keys()).sort((a, b) => a - b)) content.appendChild(createUnitDropdown(group, unit));
    dd.querySelector('.nav-dropdown-header').addEventListener('click', () => dd.classList.toggle('open'));
    dd.querySelector('.nav-item.combined').addEventListener('click', e => { e.stopPropagation(); loadCombinedView(group, null); });
    wrap.appendChild(dd); return wrap;
}

function createUnitDropdown(group, unit) {
    const um = getUnitMeta(group, unit), cm = getCombinedMeta(`${group}0${unit}`);
    const dd = document.createElement('div'); dd.className = 'nav-dropdown';
    dd.innerHTML = `<div class="nav-dropdown-header"><span class="nav-dropdown-icon">‚ñ∂</span><span class="nav-dropdown-title">${um.emoji} ${um.name}</span><span class="nav-dropdown-badge">${countPublicNotesInUnit(group, unit)}</span></div><div class="nav-dropdown-content"><div class="nav-item combined" data-combined="${group}0${unit}"><span class="nav-item-emoji">${cm.emoji}</span><span class="nav-item-name">${group}0${unit} - ${cm.name}</span></div></div>`;
    const content = dd.querySelector('.nav-dropdown-content');
    for (const noteId of AppState.groups.get(group).get(unit)) {
        const note = AppState.notes.get(noteId), isLocked = note.meta.password !== null && !AppState.unlockedNotes.has(noteId), hasPwd = note.meta.password !== null;
        const item = document.createElement('div'); item.className = 'nav-item'; item.dataset.noteId = noteId;
        item.innerHTML = `<span class="nav-item-emoji">${note.meta.emoji}</span><span class="nav-item-name">${note.meta.name}</span>${note.meta.protection === 'YES' ? '<span class="nav-item-protect">üö©</span>' : ''}${hasPwd ? (isLocked ? '<span class="nav-item-lock">üîí</span>' : '<span class="nav-item-unlock">üîì</span>') : '<span class="nav-item-unlock">üîì</span>'}`;
        item.addEventListener('click', e => { e.stopPropagation(); loadNote(noteId); });
        content.appendChild(item);
    }
    dd.querySelector('.nav-dropdown-header').addEventListener('click', e => { e.stopPropagation(); dd.classList.toggle('open'); });
    dd.querySelector('.nav-item.combined').addEventListener('click', e => { e.stopPropagation(); loadCombinedView(group, unit); });
    return dd;
}

function countPublicNotes(g) { let c = 0; for (const n of AppState.groups.get(g).values()) for (const id of n) if (AppState.notes.get(id).meta.password === null || AppState.unlockedNotes.has(id)) c++; return c; }
function countPublicNotesInUnit(g, u) { let c = 0; for (const id of AppState.groups.get(g).get(u)) if (AppState.notes.get(id).meta.password === null || AppState.unlockedNotes.has(id)) c++; return c; }

// ========================================
// Loading Content
// ========================================
async function loadReadme() {
    if (!AppState.hasReadme) return;
    AppState.currentNote = 'readme';
    updateBreadcrumb({ meta: window.readmeMeta });
    document.getElementById('contentArea').innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><div>Loading...</div></div>';
    const rendered = await renderMarkdown(window.readmeContent);
    displayRenderedContent({ meta: window.readmeMeta }, rendered);
    document.querySelectorAll('.nav-item,.special-nav-item').forEach(el => el.classList.remove('active'));
    document.getElementById('readmeItem').classList.add('active');
}

async function loadNote(noteId) {
    const note = AppState.notes.get(noteId); if (!note) return;
    if (note.meta.password !== null && !AppState.unlockedNotes.has(noteId)) { showPasswordPrompt(noteId); return; }
    AppState.currentNote = noteId;
    updateActiveNavItem(noteId);
    updateBreadcrumb(note);
    document.getElementById('contentArea').innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><div>Rendering...</div></div>';
    const rendered = await renderMarkdown(note.content);
    displayRenderedContent(note, rendered);
}

async function loadNoteAndScrollToHeading(noteId, headingId) {
    await loadNote(noteId);
    setTimeout(() => { const h = document.getElementById(headingId); if (h) h.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
}

async function loadCombinedView(group, unit) {
    document.getElementById('contentArea').innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><div>Combining...</div></div>';
    const notes = [], key = unit === null ? `${group}0` : `${group}0${unit}`, meta = getCombinedMeta(key);
    if (unit === null) { for (const [u, ids] of AppState.groups.get(group)) for (const id of ids) { const n = AppState.notes.get(id); if (n.meta.password === null || AppState.unlockedNotes.has(id)) notes.push(n); } }
    else { for (const id of AppState.groups.get(group).get(unit)) { const n = AppState.notes.get(id); if (n.meta.password === null || AppState.unlockedNotes.has(id)) notes.push(n); } }
    updateBreadcrumb({ group, unit, meta });
    if (notes.length === 0) { document.getElementById('contentArea').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîí</div><div class="empty-state-title">No Public Notes</div></div>'; return; }
    const combined = notes.map(n => n.content).join('\n\n---\n\n');
    const rendered = await renderMarkdown(combined);
    displayRenderedContent({ meta }, rendered, true, notes);
}

async function loadPublicAllNotes() {
    document.getElementById('contentArea').innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><div>Loading all...</div></div>';
    const notes = [];
    for (const group of Array.from(AppState.groups.keys()).sort())
        for (const unit of Array.from(AppState.groups.get(group).keys()).sort((a, b) => a - b))
            for (const id of AppState.groups.get(group).get(unit)) { const n = AppState.notes.get(id); if (n.meta.password === null || AppState.unlockedNotes.has(id)) notes.push(n); }
    const meta = window.publicAllMeta || { name: 'Public All Notes', emoji: 'üåê' };
    updateBreadcrumb({ meta });
    if (notes.length === 0) { document.getElementById('contentArea').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîí</div><div class="empty-state-title">No Public Notes</div></div>'; return; }
    const combined = notes.map(n => n.content).join('\n\n---\n\n');
    const rendered = await renderMarkdown(combined);
    displayRenderedContent({ meta }, rendered, true, notes);
    document.querySelectorAll('.nav-item,.special-nav-item').forEach(el => el.classList.remove('active'));
    document.getElementById('publicAllItem').classList.add('active');
}

function displayRenderedContent(note, rendered, isCombined = false, notesInCombined = []) {
    const area = document.getElementById('contentArea');
    AppState.originalContent = rendered.html || rendered.get('html');
    const html = rendered.html || rendered.get('html');
    const toc = isCombined && notesInCombined.length ? generateCombinedTOC(html, notesInCombined) : generateCustomTOC(html);
    area.innerHTML = `<header class="content-header"><h1 class="content-title"><span class="content-title-emoji">${note.meta.emoji}</span>${note.meta.name}</h1><div class="content-meta">${note.meta.description || (isCombined ? `${notesInCombined.length} notes combined` : 'Individual note')}</div></header>${toc ? `<nav class="toc-container" id="toc-container"><div class="toc-title">üìã Table of Contents</div><ul class="toc-list${isCombined ? '' : ' single-column'}">${toc}</ul></nav>` : ''}<div class="markdown-body" id="markdownBody">${html}</div>`;

    // Determine protection state: either note.meta.protection or any note in combined
    const metaObj = note && note.meta ? note.meta : {};
    let isProtected = metaObj.protection === 'YES';
    if (!isProtected && isCombined && Array.isArray(notesInCombined)) {
        isProtected = notesInCombined.some(n => n.meta && n.meta.protection === 'YES');
    }

    // Insert a print notice (visible only during print) when protected
    const existingNotice = area.querySelector('.protected-print-notice');
    if (isProtected) {
        if (!existingNotice) {
            const headerEl = area.querySelector('.content-header') || area.firstElementChild;
            if (headerEl) headerEl.insertAdjacentHTML('afterend', '<div class="protected-print-notice">üîí Protected content ‚Äî printing and copying disabled.</div>');
        }
    } else {
        if (existingNotice) existingNotice.remove();
    }

    // Apply protection behaviors
    enforceProtection(document.getElementById('markdownBody'), isProtected);

    addHeadingIds();
    setupTableFilters();
    setupTocClickHandlers();
    clearSearch();
}

function generateCombinedTOC(html, notes) {
    let toc = '';
    AppState.headingIdMap = {};
    AppState.headingCounter = 0;
    
    // Parse HTML to find actual heading sections separated by <hr>
    const div = document.createElement('div');
    div.innerHTML = html;
    const sections = [];
    let currentSection = [];
    
    for (const node of div.childNodes) {
        if (node.nodeName === 'HR') {
            if (currentSection.length > 0) {
                sections.push(currentSection);
                currentSection = [];
            }
        } else {
            currentSection.push(node);
        }
    }
    if (currentSection.length > 0) sections.push(currentSection);
    
    // For each section (note), find headings and create TOC
    for (let noteIndex = 0; noteIndex < sections.length && noteIndex < notes.length; noteIndex++) {
        const section = sections[noteIndex];
        const note = notes[noteIndex];
        const headings = [];
        
        for (const node of section) {
            if (node.nodeName === 'H1' || node.nodeName === 'H2') {
                headings.push({
                    level: parseInt(node.nodeName.charAt(1)),
                    text: node.textContent.trim(),
                    node: node
                });
            }
        }
        
        if (headings.length > 0) {
            toc += `<li class="toc-group-header">${note.meta.emoji} ${note.meta.name}</li>`;
            for (const h of headings) {
                const headingId = `heading-${AppState.headingCounter++}`;
                AppState.headingIdMap[headingId] = { noteIndex, text: h.text, level: h.level };
                toc += `<li class="toc-item level-${h.level}"><a class="toc-link" href="#${headingId}">${h.text}</a></li>`;
            }
        }
    }
    return toc;
}

function generateCustomTOC(html) {
    const div = document.createElement('div'); div.innerHTML = html;
    const headings = div.querySelectorAll('h1, h2');
    if (headings.length === 0) return '';
    let toc = '';
    AppState.headingIdMap = {};
    AppState.headingCounter = 0;
    headings.forEach(h => {
        const level = parseInt(h.tagName.charAt(1)), text = h.textContent.trim();
        const headingId = `heading-${AppState.headingCounter++}`;
        AppState.headingIdMap[headingId] = { text, level };
        toc += `<li class="toc-item level-${level}"><a class="toc-link" href="#${headingId}">${text}</a></li>`;
    });
    return toc;
}

function addHeadingIds() {
    const body = document.getElementById('markdownBody'); if (!body) return;
    
    // Match headings in DOM with the IDs assigned during TOC generation
    const headings = body.querySelectorAll('h1, h2');
    let headingIndex = 0;
    
    for (const h of headings) {
        const headingId = `heading-${headingIndex}`;
        if (AppState.headingIdMap && AppState.headingIdMap[headingId]) {
            h.id = headingId;
        }
        headingIndex++;
        
        // Add "‚Üë TOC" link for h1 and h2
        if (!h.querySelector('.heading-toc-link')) {
            const link = document.createElement('a'); link.className = 'heading-toc-link'; link.href = '#toc-container';
            link.textContent = '‚Üë TOC'; link.title = 'Back to TOC';
            link.addEventListener('click', e => { e.preventDefault(); const t = document.querySelector('.toc-container'); if (t) t.scrollIntoView({ behavior: 'smooth' }); else window.scrollTo({ top: 0, behavior: 'smooth' }); });
            h.appendChild(link);
        }
    }
    
    // Assign IDs to other headings (h3-h6) not in TOC
    let otherIndex = 0;
    body.querySelectorAll('h3,h4,h5,h6').forEach(h => {
        if (!h.id) {
            h.id = `heading-other-${otherIndex++}`;
        }
    });
}

// Protection enforcement: global handlers check AppState.currentProtected
function enforceProtection(area, isProtected) {
    AppState.currentProtected = !!isProtected;
    if (!area) return;

    // Disable/enable copy buttons inside this area
    const copyBtns = area.querySelectorAll('.copy-table-btn, .copy-format-item');
    copyBtns.forEach(b => {
        if (isProtected) { b.setAttribute('disabled', 'true'); b.setAttribute('aria-disabled', 'true'); b.title = 'Disabled for protected content'; }
        else { b.removeAttribute('disabled'); b.removeAttribute('aria-disabled'); b.title = '' }
    });

    // Make images/links non-draggable/clickable when protected
    area.querySelectorAll('img,video').forEach(el => { el.draggable = !isProtected; if (isProtected) el.setAttribute('oncontextmenu', "return false;"); else el.removeAttribute('oncontextmenu'); });
    area.querySelectorAll('a').forEach(a => { if (isProtected) { a.dataset._href = a.getAttribute('href'); a.removeAttribute('href'); } else { if (a.dataset._href) a.setAttribute('href', a.dataset._href); } });
}

// ========================================
// Table Filtering & Media Gallery
// ========================================
function detectMediaTable(table) {
    const mediaExtensions = /\.(jpg|jpeg|png|gif|nef|mp4|mp3|mov|webm|webp)(\?|$|#)/i;
    const rows = table.querySelectorAll('tbody tr, tr:not(:first-child)');
    if (rows.length === 0) return false;
    for (const row of rows) {
        const cells = row.querySelectorAll('td');
        for (const cell of cells) {
            if (mediaExtensions.test(cell.textContent.trim())) return true;
        }
    }
    return false;
}

function convertToMediaGallery(table) {
    const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.trim().toLowerCase());
    const rows = Array.from(table.querySelectorAll('tbody tr, tr:not(:first-child)'));
    
    const gallery = document.createElement('div');
    gallery.className = 'media-gallery';
    
    rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('td'));
        if (cells.length === 0) return;
        
        const data = {};
        cells.forEach((cell, idx) => {
            const header = headers[idx] || `col${idx}`;
            data[header] = cell.textContent.trim();
        });
        
        const title = data.title || data.name || 'Untitled';
        const caption = data.caption || data.description || '';
        const subcaption = data.subcaption || '';
        const url = data.url || data.link || data.media || '';
        const password = data.password || null;
        
        if (!url) return;
        
        const item = document.createElement('div');
        item.className = 'media-item';
        
        const isImage = /\.(jpg|jpeg|png|gif|webp|nef)(\?|$|#)/i.test(url);
        const isVideo = /\.(mp4|mov|webm|mp3)(\?|$|#)/i.test(url);
        
        let thumbnail = '';
        if (isImage) {
            thumbnail = `<img src="${url}" alt="${title}" onerror="this.style.display='none';this.parentElement.innerHTML+='üñºÔ∏è'">`;
        } else if (isVideo) {
            thumbnail = `<video controls><source src="${url}"></video>`;
        } else {
            thumbnail = isImage ? 'üñºÔ∏è' : 'üé¨';
        }
        
        item.innerHTML = `
            <div class="media-item-thumbnail">${thumbnail}</div>
            <div class="media-item-content">
                <div class="media-item-title">${title}</div>
                ${caption ? `<div class="media-item-caption">${caption}</div>` : ''}
                ${subcaption ? `<div class="media-item-subcaption">${subcaption}</div>` : ''}
                ${password ? `<div class="media-item-lock">Password Protected</div>` : ''}
            </div>
        `;
        
        gallery.appendChild(item);
    });
    
    return gallery;
}

function setupTableFilters() {
    const body = document.getElementById('markdownBody'); if (!body) return;
    body.querySelectorAll('table').forEach((table, idx) => {
        const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.trim());
        if (headers.length === 0) return;
        
        // Apply truncation to all table cells
        table.querySelectorAll('td').forEach(cell => {
            TruncationManager.applyToCell(cell);
            // Add click handler to toggle full text on click
            cell.addEventListener('click', (e) => {
                e.stopPropagation();
                const isCurrentlyTruncated = cell.classList.contains('table-cell-truncated');
                if (isCurrentlyTruncated) {
                    cell.title = cell.textContent;
                }
            });
        });
        
        // Check if this is a media table
        if (detectMediaTable(table)) {
            const gallery = convertToMediaGallery(table);
            const header = document.createElement('div');
            header.className = 'media-gallery-header';
            header.textContent = 'üé® Media Gallery';
            table.parentNode.insertBefore(header, table);
            table.parentNode.insertBefore(gallery, table);
            table.style.display = 'none';
            return;
        }
        
        processTableLinks(table);
        const wrapper = document.createElement('div'); wrapper.className = 'table-filter-wrapper'; wrapper.id = `filter-${idx}`;
        wrapper.innerHTML = `<div class="table-filter-header"><span class="table-filter-title">üîç Filter Table</span><button class="table-filter-toggle" data-idx="${idx}">Show/Hide</button></div><div class="table-filter-rules" id="rules-${idx}" style="display:none;"></div><div class="filter-actions" id="actions-${idx}" style="display:none;"><button class="filter-btn filter-add-btn" data-idx="${idx}">+ Add Rule</button><button class="filter-btn filter-apply-btn" data-idx="${idx}">Apply</button><button class="filter-btn filter-clear-btn" data-idx="${idx}">Clear</button></div><div class="filter-results" id="results-${idx}"></div><div class="table-copy-wrapper"><button class="copy-table-btn" data-table-idx="${idx}" title="Copy table in different formats">üìã Copy</button><div class="copy-formats-dropdown" id="dropdown-${idx}"><div class="copy-format-item" data-format="markdown">Markdown</div><div class="copy-format-item" data-format="json">JSON</div><div class="copy-format-item" data-format="html">HTML</div><div class="copy-format-item" data-format="csv">CSV</div><div class="copy-format-item" data-format="tsv">TSV</div></div></div>`;
        table.parentNode.insertBefore(wrapper, table);
        wrapper.querySelector('.table-filter-toggle').addEventListener('click', () => {
            const rules = document.getElementById(`rules-${idx}`), actions = document.getElementById(`actions-${idx}`);
            const show = rules.style.display === 'none';
            rules.style.display = show ? 'flex' : 'none';
            actions.style.display = show ? 'flex' : 'none';
            if (show && document.getElementById(`rules-${idx}`).children.length === 0) addFilterRule(idx, headers);
        });
        wrapper.querySelector('.filter-add-btn').addEventListener('click', () => addFilterRule(idx, headers));
        wrapper.querySelector('.filter-apply-btn').addEventListener('click', () => applyTableFilter(idx, table, headers));
        wrapper.querySelector('.filter-clear-btn').addEventListener('click', () => clearTableFilter(idx, table));
        const copyBtn = wrapper.querySelector('.copy-table-btn');
        const dropdown = wrapper.querySelector('.copy-formats-dropdown');
        copyBtn.addEventListener('click', (e) => { e.stopPropagation(); dropdown.classList.toggle('open'); });
        dropdown.querySelectorAll('.copy-format-item').forEach(item => {
            item.addEventListener('click', () => copyTableInFormat(table, item.dataset.format, copyBtn, dropdown));
        });
        document.addEventListener('click', (e) => {
            if (!wrapper.contains(e.target)) dropdown.classList.remove('open');
        });
    });
}

function processTableLinks(table) {
    const urlRegex = /^(https?:\/\/[^\s]+)$/i;
    table.querySelectorAll('td, th').forEach(cell => {
        const text = cell.textContent.trim();
        if (urlRegex.test(text)) {
            const truncated = truncateUrl(text);
            cell.innerHTML = `<a href="${text}" target="_blank" rel="noopener noreferrer" title="${text}">${truncated}</a>`;
        }
    });
}

function truncateUrl(url, maxLength = 40) {
    if (url.length <= maxLength) return url;
    const start = url.substring(0, 15);
    const end = url.substring(url.length - 10);
    return `${start}...${end}`;
}

function addFilterRule(idx, headers) {
    const container = document.getElementById(`rules-${idx}`), ruleIdx = container.children.length;
    const rule = document.createElement('div'); rule.className = 'filter-rule'; rule.dataset.ruleIdx = ruleIdx;
    rule.innerHTML = `${ruleIdx > 0 ? '<select class="filter-logic-select"><option value="AND">AND</option><option value="OR">OR</option></select>' : ''}<select class="filter-column">${headers.map((h, i) => `<option value="${i}">${h}</option>`).join('')}</select><select class="filter-operator"><option value="contains">CONTAINS</option><option value="equals">EQUALS</option><option value="like">LIKE (%)</option><option value="not_contains">NOT CONTAINS</option><option value="not_equals">NOT EQUALS</option><option value="gt">></option><option value="lt"><</option><option value="gte">>=</option><option value="lte"><=</option></select><input type="text" class="filter-value" placeholder="Value..."><button class="filter-rule-remove">‚úï</button>`;
    rule.querySelector('.filter-rule-remove').addEventListener('click', () => { rule.remove(); });
    container.appendChild(rule);
}

function applyTableFilter(idx, table, headers) {
    const rules = Array.from(document.getElementById(`rules-${idx}`).querySelectorAll('.filter-rule'));
    const rows = table.querySelectorAll('tbody tr, tr:not(:first-child)');
    let matchCount = 0, totalCount = rows.length;
    rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('td'));
        if (cells.length === 0) return;
        let match = null;
        rules.forEach((rule, i) => {
            const col = parseInt(rule.querySelector('.filter-column').value);
            const op = rule.querySelector('.filter-operator').value;
            const val = rule.querySelector('.filter-value').value;
            const cellVal = cells[col]?.textContent.trim() || '';
            const ruleMatch = evaluateCondition(cellVal, op, val);
            if (i === 0) { match = ruleMatch; }
            else {
                const logic = rule.querySelector('.filter-logic-select')?.value || 'AND';
                match = logic === 'AND' ? (match && ruleMatch) : (match || ruleMatch);
            }
        });
        if (match) { row.classList.remove('filtered-out'); row.classList.add('filter-match'); matchCount++; }
        else { row.classList.add('filtered-out'); row.classList.remove('filter-match'); }
    });
    document.getElementById(`results-${idx}`).textContent = `Showing ${matchCount} of ${totalCount} rows`;
}

function evaluateCondition(cellVal, op, filterVal) {
    const cv = cellVal.toLowerCase(), fv = filterVal.toLowerCase();
    switch (op) {
        case 'contains': return cv.includes(fv);
        case 'equals': return cv === fv;
        case 'like': return new RegExp('^' + fv.replace(/%/g, '.*') + '$', 'i').test(cellVal);
        case 'not_contains': return !cv.includes(fv);
        case 'not_equals': return cv !== fv;
        case 'gt': return parseFloat(cellVal) > parseFloat(filterVal);
        case 'lt': return parseFloat(cellVal) < parseFloat(filterVal);
        case 'gte': return parseFloat(cellVal) >= parseFloat(filterVal);
        case 'lte': return parseFloat(cellVal) <= parseFloat(filterVal);
        default: return true;
    }
}

function clearTableFilter(idx, table) {
    table.querySelectorAll('tr').forEach(r => { r.classList.remove('filtered-out', 'filter-match'); });
    document.getElementById(`results-${idx}`).textContent = '';
}

function copyTableToClipboard(table, button) {
    if (AppState.currentProtected) { console.warn('Copy disabled for protected content'); return; }
    const rows = [];
    table.querySelectorAll('tr').forEach(row => {
        const cells = [];
        row.querySelectorAll('td, th').forEach(cell => {
            cells.push(cell.textContent.trim());
        });
        if (cells.length > 0) rows.push(cells.join('\t'));
    });
    const text = rows.join('\n');
    navigator.clipboard.writeText(text).then(() => {
        const originalText = button.textContent;
        button.textContent = '‚úì Copied';
        button.classList.add('copied');
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('copied');
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy table:', err);
    });
}

function getTableData(table) {
    const headers = [];
    const rows = [];
    
    // Helper function to extract text preserving line breaks
    const getCellContent = (cell) => {
        const cloned = cell.cloneNode(true);
        let text = '';
        cloned.childNodes.forEach(node => {
            if (node.nodeType === Node.TEXT_NODE) {
                text += node.textContent;
            } else if (node.nodeType === Node.ELEMENT_NODE) {
                if (node.tagName === 'BR') {
                    text += '\n';
                } else {
                    text += node.textContent;
                }
            }
        });
        return text.trim();
    };
    
    table.querySelectorAll('thead tr').forEach(row => {
        row.querySelectorAll('th').forEach(cell => headers.push(getCellContent(cell)));
    });
    if (headers.length === 0) {
        const firstRow = table.querySelector('tr');
        if (firstRow) firstRow.querySelectorAll('th').forEach(cell => headers.push(getCellContent(cell)));
    }
    table.querySelectorAll('tbody tr, tr:not(:first-child)').forEach(row => {
        const cells = [];
        row.querySelectorAll('td, th').forEach(cell => cells.push(getCellContent(cell)));
        if (cells.length > 0) rows.push(cells);
    });
    return { headers, rows };
}

function tableToMarkdown(data) {
    const { headers, rows } = data;
    const escapeMarkdown = (str) => str.replace(/\n/g, '<br>');
    let markdown = '| ' + headers.map(escapeMarkdown).join(' | ') + ' |\n';
    markdown += '|' + headers.map(() => '---|').join('') + '\n';
    rows.forEach(row => {
        markdown += '| ' + row.map(escapeMarkdown).join(' | ') + ' |\n';
    });
    return markdown;
}

function tableToJSON(data) {
    const { headers, rows } = data;
    const json = rows.map(row => {
        const obj = {};
        headers.forEach((header, idx) => obj[header] = row[idx] || '');
        return obj;
    });
    return JSON.stringify(json, null, 2);
}

function tableToHTML(data) {
    const { headers, rows } = data;
    const escapeHTML = (str) => {
        const div = document.createElement('div');
        div.textContent = str;
        let html = div.innerHTML;
        // Preserve line breaks as <br> tags
        html = html.replace(/\n/g, '<br>');
        return html;
    };
    let html = '<table>\n<thead>\n<tr>\n';
    headers.forEach(header => html += `<th>${escapeHTML(header)}</th>\n`);
    html += '</tr>\n</thead>\n<tbody>\n';
    rows.forEach(row => {
        html += '<tr>\n';
        row.forEach(cell => html += `<td>${escapeHTML(cell)}</td>\n`);
        html += '</tr>\n';
    });
    html += '</tbody>\n</table>';
    return html;
}

function tableToCSV(data) {
    const { headers, rows } = data;
    const escapeCSV = (str) => {
        // CSV fields with line breaks, commas, or quotes must be quoted and internal quotes doubled
        if (str.includes(',') || str.includes('"') || str.includes('\n') || str.includes('\r')) {
            return '"' + str.replace(/"/g, '""') + '"';
        }
        return str;
    };
    let csv = headers.map(escapeCSV).join(',') + '\n';
    rows.forEach(row => {
        csv += row.map(escapeCSV).join(',') + '\n';
    });
    return csv;
}

function tableToTSV(data) {
    const { headers, rows } = data;
    // TSV: preserve line breaks as-is within tab-separated values
    let tsv = headers.join('\t') + '\n';
    rows.forEach(row => {
        tsv += row.join('\t') + '\n';
    });
    return tsv;
}

function copyTableInFormat(table, format, button, dropdown) {
    if (AppState.currentProtected) { console.warn('Copy disabled for protected content'); return; }
    const data = getTableData(table);
    let content = '';
    
    switch (format) {
        case 'markdown': content = tableToMarkdown(data); break;
        case 'json': content = tableToJSON(data); break;
        case 'html': content = tableToHTML(data); break;
        case 'csv': content = tableToCSV(data); break;
        case 'tsv': content = tableToTSV(data); break;
    }
    
    navigator.clipboard.writeText(content).then(() => {
        dropdown.classList.remove('open');
        const originalText = button.textContent;
        button.textContent = '‚úì Copied';
        button.classList.add('copied');
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('copied');
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy table:', err);
    });
}

// ========================================
// Password (Notes)
// ========================================
function showPasswordPrompt(noteId) {
    const note = AppState.notes.get(noteId), overlay = document.getElementById('passwordOverlay');
    document.getElementById('passwordNoteTitle').textContent = `Unlock "${note.meta.name}"`;
    document.getElementById('passwordInput').value = '';
    document.getElementById('passwordError').classList.remove('visible');
    overlay.dataset.noteId = noteId;
    overlay.classList.add('visible');
    setTimeout(() => document.getElementById('passwordInput').focus(), 100);
}
function hidePasswordPrompt() { document.getElementById('passwordOverlay').classList.remove('visible'); }
function validatePassword() {
    const overlay = document.getElementById('passwordOverlay'), noteId = overlay.dataset.noteId;
    const input = document.getElementById('passwordInput'), error = document.getElementById('passwordError');
    const note = AppState.notes.get(noteId);
    if (input.value === note.meta.password) { AppState.unlockedNotes.add(noteId); hidePasswordPrompt(); buildNavigation(); loadNote(noteId); }
    else { error.classList.add('visible'); input.value = ''; input.focus(); }
}

// ========================================
// Search
// ========================================
function performSearch(query) {
    const body = document.getElementById('markdownBody');
    if (!body || !query.trim()) { clearSearch(); return; }
    body.innerHTML = AppState.originalContent;
    addHeadingIds();
    processSmartLinks();
    processMediaGalleries();
    AppState.searchMatches = [];
    AppState.currentMatchIndex = -1;
    const isNepali = NepaliNormalizer.isDevanagari(query);
    if (isNepali) highlightDevanagari(body, query);
    else highlightMatches(body, query.toLowerCase());
    updateSearchUI();
    if (AppState.searchMatches.length > 0) navigateToMatch(0);
}

function highlightDevanagari(el, query) {
    const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT, null, false);
    const nodes = []; while (walker.nextNode()) nodes.push(walker.currentNode);
    const normQuery = NepaliNormalizer.normalize(query.toLowerCase());
    for (const node of nodes) {
        const text = node.textContent, normText = NepaliNormalizer.normalize(text.toLowerCase());
        const matches = [];
        let start = 0;
        while (start < normText.length) {
            const found = normText.indexOf(normQuery, start);
            if (found === -1) break;
            const origStart = NepaliNormalizer.mapToOriginal(found, text, normText);
            const origEnd = NepaliNormalizer.mapToOriginal(found + normQuery.length, text, normText);
            if (origStart !== -1 && origEnd !== -1 && origStart < origEnd) matches.push({ start: origStart, end: origEnd });
            start = found + 1;
        }
        if (matches.length > 0) {
            const frag = document.createDocumentFragment();
            let last = 0;
            for (const m of matches) {
                if (m.start > last) frag.appendChild(document.createTextNode(text.substring(last, m.start)));
                const mark = document.createElement('mark'); mark.className = 'search-highlight';
                mark.textContent = text.substring(m.start, m.end);
                mark.dataset.matchIndex = AppState.searchMatches.length;
                AppState.searchMatches.push(mark);
                frag.appendChild(mark);
                last = m.end;
            }
            if (last < text.length) frag.appendChild(document.createTextNode(text.substring(last)));
            node.parentNode.replaceChild(frag, node);
        }
    }
}

function highlightMatches(el, query) {
    const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT, null, false);
    const nodes = []; while (walker.nextNode()) nodes.push(walker.currentNode);
    for (const node of nodes) {
        const text = node.textContent;
        if (text.toLowerCase().includes(query)) {
            const frag = document.createDocumentFragment();
            const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            let last = 0, match;
            while ((match = regex.exec(text)) !== null) {
                if (match.index > last) frag.appendChild(document.createTextNode(text.substring(last, match.index)));
                const mark = document.createElement('mark'); mark.className = 'search-highlight';
                mark.textContent = match[0]; mark.dataset.matchIndex = AppState.searchMatches.length;
                AppState.searchMatches.push(mark); frag.appendChild(mark);
                last = regex.lastIndex;
            }
            if (last < text.length) frag.appendChild(document.createTextNode(text.substring(last)));
            node.parentNode.replaceChild(frag, node);
        }
    }
}

function navigateToMatch(idx) {
    if (AppState.searchMatches.length === 0) return;
    if (AppState.currentMatchIndex >= 0) AppState.searchMatches[AppState.currentMatchIndex]?.classList.remove('active');
    AppState.currentMatchIndex = idx;
    const match = AppState.searchMatches[idx];
    if (match) { match.classList.add('active'); match.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    updateSearchUI();
}
function navigatePrevMatch() { if (AppState.searchMatches.length === 0) return; let idx = AppState.currentMatchIndex - 1; if (idx < 0) idx = AppState.searchMatches.length - 1; navigateToMatch(idx); }
function navigateNextMatch() { if (AppState.searchMatches.length === 0) return; let idx = AppState.currentMatchIndex + 1; if (idx >= AppState.searchMatches.length) idx = 0; navigateToMatch(idx); }
function clearSearch() {
    document.getElementById('searchInput').value = '';
    AppState.searchMatches = []; AppState.currentMatchIndex = -1;
    const body = document.getElementById('markdownBody');
    if (body && AppState.originalContent) { body.innerHTML = AppState.originalContent; addHeadingIds(); processSmartLinks(); processMediaGalleries(); setupTableFilters(); setupTocClickHandlers(); }
    updateSearchUI();
}
function updateSearchUI() {
    const nav = document.getElementById('searchNav'), counter = document.getElementById('searchCounter');
    const prev = document.getElementById('searchPrev'), next = document.getElementById('searchNext');
    const clear = document.getElementById('clearSearch'), input = document.getElementById('searchInput');
    const hasMatches = AppState.searchMatches.length > 0, hasQuery = input.value.trim().length > 0;
    nav.classList.toggle('visible', hasQuery);
    clear.classList.toggle('visible', hasQuery);
    if (hasMatches) { counter.textContent = `${AppState.currentMatchIndex + 1} / ${AppState.searchMatches.length}`; prev.disabled = false; next.disabled = false; }
    else { counter.textContent = hasQuery ? '0 / 0' : ''; prev.disabled = true; next.disabled = true; }
}

// ========================================
// UI Helpers
// ========================================
function updateActiveNavItem(noteId) {
    document.querySelectorAll('.nav-item,.special-nav-item').forEach(el => el.classList.remove('active'));
    const item = document.querySelector(`.nav-item[data-note-id="${noteId}"]`);
    if (item) { item.classList.add('active'); let p = item.closest('.nav-dropdown'); while (p) { p.classList.add('open'); p = p.parentElement.closest('.nav-dropdown'); } }
}
function updateBreadcrumb(note) {
    const bc = document.getElementById('breadcrumb');
    let path = ['Notes'];
    if (note.group) path.push(`Group ${note.group}`);
    if (note.unit) path.push(`Unit ${note.unit}`);
    path.push(note.meta.name);
    bc.innerHTML = path.map((item, i) => `<span class="breadcrumb-item ${i === path.length - 1 ? 'active' : ''}">${item}</span>${i < path.length - 1 ? '<span class="breadcrumb-separator">/</span>' : ''}`).join('');
}
function setupBackToTop() {
    const btn = document.getElementById('backToTop');
    window.addEventListener('scroll', () => { btn.classList.toggle('visible', window.scrollY > 300); });
    btn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
}

// Global protection handlers: prevent copy/select/print when viewing protected content
(function() {
    document.addEventListener('copy', (e) => {
        if (!AppState.currentProtected) return;
        const body = document.getElementById('markdownBody'); if (!body) return;
        if (body.contains(e.target)) e.preventDefault();
    });
    ['cut','contextmenu','selectstart','dragstart'].forEach(ev => document.addEventListener(ev, (e) => {
        if (!AppState.currentProtected) return;
        const body = document.getElementById('markdownBody'); if (!body) return;
        if (body.contains(e.target)) e.preventDefault();
    }));

    window.addEventListener('keydown', (e) => {
        if (!AppState.currentProtected) return;
        const body = document.getElementById('markdownBody'); if (!body) return;
        if (!body.contains(document.activeElement) && !body.contains(e.target)) return;
        // Block common copy/print/save shortcuts
        if ((e.ctrlKey || e.metaKey) && ['c','p','s','a'].includes((e.key || '').toLowerCase())) {
            e.preventDefault(); e.stopPropagation();
        }
    });
})();

// ========================================
// Event Listeners
// ========================================
function setupEventListeners() {
    document.getElementById('masterTocHeader').addEventListener('click', () => document.getElementById('masterTocContainer').classList.toggle('open'));
    document.getElementById('readmeItem').addEventListener('click', loadReadme);
    document.getElementById('publicAllItem').addEventListener('click', loadPublicAllNotes);
    
    // Note password modal
    document.getElementById('passwordCancel').addEventListener('click', hidePasswordPrompt);
    document.getElementById('passwordSubmit').addEventListener('click', validatePassword);
    document.getElementById('passwordInput').addEventListener('keypress', e => { if (e.key === 'Enter') validatePassword(); });
    document.getElementById('passwordOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) hidePasswordPrompt(); });
    
    // Media password modal
    document.getElementById('mediaPasswordCancel').addEventListener('click', hideMediaPasswordPrompt);
    document.getElementById('mediaPasswordSubmit').addEventListener('click', validateMediaPassword);
    document.getElementById('mediaPasswordInput').addEventListener('keypress', e => { if (e.key === 'Enter') validateMediaPassword(); });
    document.getElementById('mediaPasswordOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) hideMediaPasswordPrompt(); });
    
    // Lightbox
    document.getElementById('lightboxClose').addEventListener('click', closeLightbox);
    document.getElementById('lightboxPrev').addEventListener('click', () => navigateLightbox(-1));
    document.getElementById('lightboxNext').addEventListener('click', () => navigateLightbox(1));
    document.getElementById('lightboxOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeLightbox(); });
    
    // Search
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', e => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => performSearch(e.target.value), 300); });
    document.getElementById('searchPrev').addEventListener('click', navigatePrevMatch);
    document.getElementById('searchNext').addEventListener('click', navigateNextMatch);
    document.getElementById('clearSearch').addEventListener('click', clearSearch);
    
    // Keyboard shortcuts
    document.addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') { e.preventDefault(); document.getElementById('searchInput').focus(); }
        if (e.key === 'F3' || (e.key === 'Enter' && document.activeElement.id === 'searchInput')) { e.preventDefault(); e.shiftKey ? navigatePrevMatch() : navigateNextMatch(); }
        if (e.key === 'Escape') {
            if (document.getElementById('lightboxOverlay').classList.contains('visible')) { closeLightbox(); }
            else if (document.getElementById('mediaPasswordOverlay').classList.contains('visible')) { hideMediaPasswordPrompt(); }
            else if (document.getElementById('passwordOverlay').classList.contains('visible')) { hidePasswordPrompt(); }
            else { clearSearch(); document.getElementById('searchInput').blur(); }
        }
        // Lightbox navigation
        if (document.getElementById('lightboxOverlay').classList.contains('visible')) {
            if (e.key === 'ArrowLeft') navigateLightbox(-1);
            if (e.key === 'ArrowRight') navigateLightbox(1);
        }
    });
    
    document.getElementById('mobileMenuBtn').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('open'));
}

// ========================================
// Init
// ========================================
async function init() {
    ThemeManager.init();
    TruncationManager.init();
    PDFDownloadManager.init();
    discoverNotes();
    await initPyodide();
    buildNavigation();
    setupEventListeners();
    setupBackToTop();
    console.log('üìö Notes Viewer initialized:', AppState.notes.size, 'notes in', AppState.groups.size, 'groups');
}
document.addEventListener('DOMContentLoaded', init);

// ========================================
// Media & Gallery Functions
// ========================================
function processSmartLinks() {
    const body = document.getElementById('markdownBody'); if (!body) return;
    // Processes smart links - currently a placeholder
}

function processMediaGalleries() {
    const body = document.getElementById('markdownBody'); if (!body) return;
    // Processes media galleries - currently a placeholder
}

function setupTocClickHandlers() {
    document.querySelectorAll('.toc-link').forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            const id = link.getAttribute('href').substring(1);
            const el = document.getElementById(id);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    });
}

// ========================================
// Lightbox Functions
// ========================================
function closeLightbox() {
    const overlay = document.getElementById('lightboxOverlay');
    if (overlay) overlay.classList.remove('visible');
}

function navigateLightbox(direction) {
    // Placeholder for lightbox navigation
}

// ========================================
// Media Password Functions
// ========================================
function hideMediaPasswordPrompt() {
    const overlay = document.getElementById('mediaPasswordOverlay');
    if (overlay) overlay.classList.remove('visible');
}

function validateMediaPassword() {
    const overlay = document.getElementById('mediaPasswordOverlay');
    const input = document.getElementById('mediaPasswordInput');
    const error = document.getElementById('mediaPasswordError');
    if (!overlay || !input) return;
    
    const mediaId = overlay.dataset.mediaId;
    const correctPassword = overlay.dataset.correctPassword || '';
    
    if (input.value === correctPassword) {
        hideMediaPasswordPrompt();
        // Reveal media element
        const mediaEl = document.getElementById(mediaId);
        if (mediaEl) mediaEl.classList.remove('locked');
    } else {
        if (error) error.classList.add('visible');
        input.value = '';
        input.focus();
    }
}

// ========================================
// DOM Initialization
// ========================================
document.addEventListener('DOMContentLoaded', () => {
    const lightboxOverlay = document.getElementById('lightboxOverlay');
    if (!lightboxOverlay) {
        const overlay = document.createElement('div');
        overlay.id = 'lightboxOverlay';
        overlay.className = 'lightbox-overlay';
        overlay.style.display = 'none';
        overlay.innerHTML = '<div class="lightbox-content"><button id="lightboxClose" class="lightbox-close">√ó</button><button id="lightboxPrev" class="lightbox-nav lightbox-prev">‚ùÆ</button><img id="lightboxImage" class="lightbox-image" /><button id="lightboxNext" class="lightbox-nav lightbox-next">‚ùØ</button></div>';
        document.body.appendChild(overlay);
    }
    
    const mediaPasswordOverlay = document.getElementById('mediaPasswordOverlay');
    if (!mediaPasswordOverlay) {
        const overlay = document.createElement('div');
        overlay.id = 'mediaPasswordOverlay';
        overlay.className = 'password-overlay';
        overlay.style.display = 'none';
        overlay.innerHTML = '<div class="password-modal"><div class="password-header">Unlock Media</div><input type="password" id="mediaPasswordInput" class="password-input" placeholder="Enter password..."><div id="mediaPasswordError" class="password-error" style="display:none;">Wrong password</div><div class="password-buttons"><button id="mediaPasswordCancel" class="password-cancel">Cancel</button><button id="mediaPasswordSubmit" class="password-submit">Unlock</button></div></div>';
        document.body.appendChild(overlay);
    }
});

document.addEventListener('DOMContentLoaded', init);
    </script>
      <script src="datanoteU14.js"></script>
</body>
</html>
